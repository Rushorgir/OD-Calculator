<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OD Manager â€” Reset Password</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“…</text></svg>">
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="supabase-config.js"></script>
</head>
<body class="login-page">
  <main style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;">
    <div style="max-width:480px;width:100%;display:flex;justify-content:center;">
      <div class="card" style="width:100%;">
        <div class="card__header">
          <h2 style="margin:0">Reset Password</h2>
          <p style="margin:6px 0 0;color:var(--color-text-secondary);font-size:13px">
            Set a new password for your account
          </p>
        </div>
        <div class="card__body">
          <form id="resetPasswordForm">
            <div class="form-group">
              <label class="form-label">New Password</label>
              <input id="resetPassword" type="password" class="form-control" placeholder="Enter new password" required />
            </div>
            <div class="form-group">
              <label class="form-label">Confirm Password</label>
              <input id="resetConfirmPassword" type="password" class="form-control" placeholder="Confirm new password" required />
            </div>
            <button type="submit" class="btn btn--primary btn--full-width">Reset Password</button>
          </form>

          <div style="margin-top:12px;text-align:center">
            <small>
              <a href="javascript:void(0);" id="backToLogin" style="color:#32b8c6; text-decoration:none;">Back to login</a>
            </small>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="toastContainer" class="toast-container"></div>

  <script>
    // Handle password reset submission
    const resetForm = document.getElementById('resetPasswordForm');

    resetForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const newPassword = document.getElementById('resetPassword').value;
      const confirmPassword = document.getElementById('resetConfirmPassword').value;

      if (!newPassword || !confirmPassword) {
        return showToast('Please fill in both fields', 'warning');
      }
      if (newPassword !== confirmPassword) {
        return showToast('Passwords do not match', 'error');
      }

      if (typeof supabaseClient === 'undefined') {
        return showToast('Supabase is not configured', 'error');
      }

      // Update the password for the current session user
      const { error } = await supabaseClient.auth.updateUser({ password: newPassword });

      if (error) {
        return showToast(error.message || 'Failed to reset password', 'error');
      }

      showToast('Password reset successfully! Redirecting to login...', 'success');
      setTimeout(() => {
        window.location.href = '/index.html';
      }, 2000);
    });

    // Back to login button: clear session and redirect
    document.getElementById('backToLogin').addEventListener('click', async () => {
      if (typeof supabaseClient !== 'undefined') {
        await supabaseClient.auth.signOut();
      }
      window.location.href = '/index.html';
    });

    // Toast helper
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) return;
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }
  </script>
</body>
</html>