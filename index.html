<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>OD Manager â€” Login</title>
        <link rel="stylesheet" href="style.css" />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
    </head>
    <body class="login-page">
        <main style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;">
            <div style="max-width:420px;width:100%">
                <div class="card">
                    <div class="card__header">
                        <h2 style="margin:0">Sign in to OD Manager</h2>
                    </div>
                    <div class="card__body">
                        <div style="margin-bottom:16px;color:var(--color-text-secondary)">Use a simple name (username) or an email. If you enter only a name, the app will append <code>@local</code> to create an internal email for Supabase.</div>

                        <div id="authTabs" style="display:flex;gap:8px;margin-bottom:16px">
                            <button id="showLogin" class="btn btn--secondary">Login</button>
                            <button id="showSignup" class="btn">Sign up</button>
                        </div>

                        <!-- Login Form -->
                        <form id="loginForm" style="display:block">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input id="loginName" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input id="loginPassword" type="password" class="form-control" required />
                            </div>
                            <button type="submit" class="btn btn--primary btn--full-width">Log in</button>
                        </form>

                        <!-- Signup Form -->
                        <form id="signupForm" style="display:none">
                            <div class="form-group">
                                <label class="form-label">Full name</label>
                                <input id="signupFullName" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Name or Email</label>
                                <input id="signupName" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input id="signupPassword" type="password" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm Password</label>
                                <input id="signupConfirmPassword" type="password" class="form-control" required />
                            </div>
                            <button type="submit" class="btn btn--primary btn--full-width">Create account</button>
                        </form>

                        <div style="margin-top:12px;text-align:center">
                            <small>After login you'll be redirected to the OD Calculator.</small>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div id="toastContainer" class="toast-container"></div>

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
        <script src="supabase-config.js"></script>

        <script>
            // Simple UI switching
            const showLogin = document.getElementById('showLogin');
            const showSignup = document.getElementById('showSignup');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');

            showLogin.addEventListener('click', () => {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                showLogin.classList.add('btn--secondary');
                showSignup.classList.remove('btn--secondary');
            });
            showSignup.addEventListener('click', () => {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                showSignup.classList.add('btn--secondary');
                showLogin.classList.remove('btn--secondary');
            });

            // helper toast
            function showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) return;
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // Use a username-only workflow: if user enters a plain name without '@', append @local
            function normalizeIdentifier(input) {
                const v = input.trim();
                return v.includes('@') ? v : `${v}@local`;
            }

            // Ensure supabaseClient exists
            if (typeof supabaseClient === 'undefined') {
                showToast('Supabase not configured. Copy supabase-config.example.js to supabase-config.js and add your keys.', 'error');
            }

            // Login handler
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('loginName').value.trim();
                const password = document.getElementById('loginPassword').value;
                if (!name || !password) return showToast('Provide credentials', 'warning');

                const email = normalizeIdentifier(name);
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    showToast(error.message || 'Login failed', 'error');
                    return;
                }
                showToast('Login successful', 'success');
                // redirect to protected app
                window.location.href = '/app.html';
            });

            // Signup handler
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fullName = document.getElementById('signupFullName').value.trim();
                const name = document.getElementById('signupName').value.trim();
                const password = document.getElementById('signupPassword').value;
                const confirm = document.getElementById('signupConfirmPassword').value;

                if (!fullName || !name || !password) return showToast('All fields required', 'warning');
                if (password !== confirm) return showToast('Passwords do not match', 'error');

                const email = normalizeIdentifier(name);

                const { data, error } = await supabaseClient.auth.signUp({ email, password }, { data: { full_name: fullName } });
                if (error) {
                    showToast(error.message || 'Signup failed', 'error');
                    return;
                }
                showToast('Account created. Check your email if verification is required. Logging you in...', 'success');
                // try to sign in immediately
                const { data: signInData, error: signInErr } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (signInErr) return showToast(signInErr.message || 'Auto-login failed', 'warning');
                window.location.href = '/app.html';
            });
        </script>
    </body>
</html>