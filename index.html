<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>OD Manager â€” Login</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“…</text></svg>">
        <link rel="stylesheet" href="style.css" />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
        <script>
            // Apply theme from localStorage before page load to prevent flash
            (function() {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = savedTheme || (prefersDark ? 'dark' : 'light');
                document.documentElement.setAttribute('data-color-scheme', theme);
            })();
        </script>
    </head>
    <body class="login-page">
        <main style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;">
            <div style="max-width:480px;width:100%;display:flex;justify-content:center;">
                <div class="card" style="width:100%;">
                    <div class="card__header">
                        <h2 style="margin:0">OD Manager</h2>
                        <p style="margin:6px 0 0;color:var(--color-text-secondary);font-size:13px">Sign in to manage your OD hours</p>
                    </div>
                    <div class="card__body">
                        <div id="authNotice" style="margin-bottom:16px;color:var(--color-text-secondary)">Sign in or create an account using your email and password.</div>

                        <div id="authTabs" style="display:flex;gap:8px;margin-bottom:16px">
                            <button id="showLogin" class="btn btn--secondary" aria-pressed="true">Login</button>
                            <button id="showSignup" class="btn" aria-pressed="false">Sign up</button>
                        </div>

                        <!-- Login Form -->
                        <form id="loginForm" style="display:block">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input id="loginEmail" type="email" class="form-control" placeholder="you@example.com" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input id="loginPassword" type="password" class="form-control" required />
                            </div>
                            <button type="submit" class="btn btn--primary btn--full-width">Log in</button>
                        </form>

                        <!-- Signup Form -->
                        <form id="signupForm" style="display:none">
                            <div class="form-group">
                                <label class="form-label">Full name (optional)</label>
                                <input id="signupFullName" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input id="signupEmail" type="email" class="form-control" placeholder="you@example.com" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input id="signupPassword" type="password" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm Password</label>
                                <input id="signupConfirmPassword" type="password" class="form-control" required />
                            </div>
                            <button type="submit" class="btn btn--primary btn--full-width">Create account</button>
                        </form>

                        <div style="margin-top:12px;text-align:center">
                            <small>After login you'll be redirected to the OD Calculator.</small>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div id="toastContainer" class="toast-container"></div>

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
        <script src="supabase-config.js"></script>

        <script>
                    // Simple UI switching
                    const showLogin = document.getElementById('showLogin');
                    const showSignup = document.getElementById('showSignup');
                    const loginForm = document.getElementById('loginForm');
                    const signupForm = document.getElementById('signupForm');

                    function setTab(isLogin) {
                        loginForm.style.display = isLogin ? 'block' : 'none';
                        signupForm.style.display = isLogin ? 'none' : 'block';
                        showLogin.classList.toggle('btn--secondary', isLogin);
                        showSignup.classList.toggle('btn--secondary', !isLogin);
                        showLogin.setAttribute('aria-pressed', isLogin ? 'true' : 'false');
                        showSignup.setAttribute('aria-pressed', !isLogin ? 'true' : 'false');
                    }

                    showLogin.addEventListener('click', () => setTab(true));
                    showSignup.addEventListener('click', () => setTab(false));

                    // helper toast
                    function showToast(message, type = 'info') {
                        const toastContainer = document.getElementById('toastContainer');
                        if (!toastContainer) return;
                        const toast = document.createElement('div');
                        toast.className = `toast ${type}`;
                        toast.textContent = message;
                        toastContainer.appendChild(toast);
                        setTimeout(() => toast.remove(), 3500);
                    }

                    // Login handler (email-only)
                    loginForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = document.getElementById('loginEmail').value.trim();
                        const password = document.getElementById('loginPassword').value;
                        if (!email || !password) return showToast('Please provide both email and password', 'warning');

                        if (typeof supabaseClient === 'undefined') return showToast('Supabase is not configured. Add your keys to supabase-config.js', 'error');

                        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                        if (error) {
                            showToast(error.message || 'Login failed', 'error');
                            return;
                        }
                        showToast('Login successful', 'success');
                        window.location.href = '/app.html';
                    });

                    // Signup handler (email-only)
                    signupForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const fullName = document.getElementById('signupFullName').value.trim();
                        const email = document.getElementById('signupEmail').value.trim();
                        const password = document.getElementById('signupPassword').value;
                        const confirm = document.getElementById('signupConfirmPassword').value;

                        if (!email || !password) return showToast('Please provide email and password', 'warning');
                        if (password !== confirm) return showToast('Passwords do not match', 'error');

                        if (typeof supabaseClient === 'undefined') return showToast('Supabase is not configured. Add your keys to supabase-config.js', 'error');

                        const { data, error } = await supabaseClient.auth.signUp({ email, password }, { data: { full_name: fullName || null } });
                        if (error) {
                            showToast(error.message || 'Signup failed', 'error');
                            return;
                        }
                        showToast('Account created!', 'success');
                        // try to sign in immediately
                        const { data: signInData, error: signInErr } = await supabaseClient.auth.signInWithPassword({ email, password });
                        if (signInErr) return showToast(signInErr.message || 'Auto-login failed', 'warning');
                        window.location.href = '/app.html';
                    });
        </script>
    </body>
</html>